### AI脑筋急转弯后端

[火山方舟管理控制台](https://console.volcengine.com/ark/region:ark+cn-beijing/assistant)

##### java后端依赖：

spring web

mysql

lombok

spring boot 2.7.6

knife4j: [快速开始 | Knife4j](https://doc.xiaominfo.com/docs/quick-start)

```java
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
    <version>4.4.0</version>
</dependency>

#示例配置：
nife4j:
  enable: true
  openapi:
    title: 脑筋急转弯api文档
    group:
      default:
        group-name: 默认分组
        api-rule: package
        api-rule-resources:
          - com.tfzhang.ainaojin.controller
```

需要将示例代码移动到controller目录下；

然后启动IDEA后，访问如下网址，就可以查看、测试api接口：

```html
http://localhost:8080/doc.html#/home
```



火山引擎的依赖文件：

```java
        <dependency>
            <groupId>com.volcengine</groupId>
            <artifactId>volcengine-java-sdk-ark-runtime</artifactId>
            <version>0.1.153</version>
        </dependency>
```



在Test目录下，创建AichatTest.java，将火山引擎的示例代码粘贴到该类；

然后在application.yml创建：

```yml
ark:
  api-key: 05b4cea0-9a20-4351-a8b6-8ddc28fb294e
```

代码中：

```java
    @Value("${ark.api-key}")
    String apiKey;

    ArkService service;	

    @BeforeEach
    public void setUp(){
        ConnectionPool connectionPool = new ConnectionPool(5, 1, TimeUnit.SECONDS);
        Dispatcher dispatcher = new Dispatcher();
        service = ArkService.builder().dispatcher(dispatcher).connectionPool(connectionPool)
                .baseUrl("https://ark.cn-beijing.volces.com/api/v3/")
                .apiKey(apiKey)
                .build();
    }

//    static String apiKey = System.getenv("ARK_API_KEY");
    @Test
    public void doTest(){
        System.out.println("\n----- standard request -----");
        ...
```



将**ArkService的初始化**独立到config包中:

```java
package com.tfzhang.aichat.config;

import com.volcengine.ark.runtime.service.ArkService;
import okhttp3.ConnectionPool;
import okhttp3.Dispatcher;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

@Configuration
public class AiConfig {

    @Value("${ai.apiKey}")
    String apiKey;

    @Bean
    public ArkService arkService(){
        ConnectionPool connectionPool = new ConnectionPool(5, 1, TimeUnit.SECONDS);
        Dispatcher dispatcher = new Dispatcher();

        return ArkService.builder().dispatcher(dispatcher)
                .connectionPool(connectionPool)
                .baseUrl("https://ark.cn-beijing.volces.com/api/v3/")
                .apiKey(apiKey).build();
    }

}
```

**注意：**

```html
要让该 ArkService 实例全局唯一并可注入到其他类，需要将其声明为 Spring Bean。可以在方法上添加 @Bean 注解，并将类加上 @Configuration 注解。这样 Spring 会自动管理该 Bean 的生命周期，实现单例注入。
```



**封装**发送与接收消息：

接收用户和系统的prompt进行聊天，抽离出两个接口：

```java
public String doChat(String userPrompt, String systemPrompt);
```

```java
public String doChat(List<ChatMessage> messages);
```

示例代码：

```java
 package com.tfzhang.ainaojin.service;

import com.volcengine.ark.runtime.model.bot.completion.chat.BotChatCompletionRequest;
import com.volcengine.ark.runtime.model.bot.completion.chat.BotChatCompletionResult;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessage;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessageRole;
import com.volcengine.ark.runtime.service.ArkService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.ArrayList;
import java.util.List;

@Service
public class AiManager {

    @Resource
    private ArkService service;

    //传入系统prompt，用户prompt；
    public String doChat(String systemPrompt, String userPrompt) {
        final List<ChatMessage> messages = new ArrayList<>();
        final ChatMessage systemMessage = ChatMessage.builder().role(ChatMessageRole.SYSTEM).content(systemPrompt).build();
        final ChatMessage userMessage = ChatMessage.builder().role(ChatMessageRole.USER).content(userPrompt).build();
        messages.add(systemMessage);
        messages.add(userMessage);

//        BotChatCompletionRequest chatCompletionRequest = BotChatCompletionRequest.builder()
//                .botId("bot-20251005202857-74jzd")
//                .messages(messages)
//                .build();
//
//        BotChatCompletionResult chatCompletionResult =  service.createBotChatCompletion(chatCompletionRequest);
//        //chatCompletionResult.getChoices().forEach(choice -> System.out.println(choice.getMessage().getContent()));
//        if(chatCompletionResult.getChoices() == null || chatCompletionResult.getChoices().isEmpty()) {
////            return "没有返回结果";
//            throw new RuntimeException("AI没有返回结果");
//        }
//        return (String)chatCompletionResult.getChoices().get(0).getMessage().getContent();
        return doChat(messages);
    }

    //允许用户传入任意条消息;
    public String doChat(List<ChatMessage> messages) {
//        final List<ChatMessage> messages = new ArrayList<>();
//        final ChatMessage systemMessage = ChatMessage.builder().role(ChatMessageRole.SYSTEM).content(systemPrompt).build();
//        final ChatMessage userMessage = ChatMessage.builder().role(ChatMessageRole.USER).content(userPrompt).build();
//        messages.add(systemMessage);
//        messages.add(userMessage);

        BotChatCompletionRequest chatCompletionRequest = BotChatCompletionRequest.builder()
                .botId("bot-20251005202857-74jzd")
                .messages(messages)
                .build();

        BotChatCompletionResult chatCompletionResult =  service.createBotChatCompletion(chatCompletionRequest);
        //chatCompletionResult.getChoices().forEach(choice -> System.out.println(choice.getMessage().getContent()));
        if(chatCompletionResult.getChoices() == null || chatCompletionResult.getChoices().isEmpty()) {
            //return "没有返回结果";
            throw new RuntimeException("AI没有返回结果");
        }
        return (String)chatCompletionResult.getChoices().get(0).getMessage().getContent();
    }

}

```



**Service层：**

```java
    //用户提供聊天室房间，以及提示词；
    String doChat(long roomId, String userPrompt);
    //返回对话列表；
    List<ChatRoom> getChatRoomList();
```

示例代码：

```java
package com.tfzhang.ainaojin.service;
import com.tfzhang.ainaojin.model.ChatRoom;
import java.util.List;

public interface ChatService {
    //实现用户与ai聊天；
    String doChat(long roomId, String userPrompt);
    //返回对话列表；
    List<ChatRoom> getChatRoomList();
}
```



其中service层的实现：

```java
package com.tfzhang.ainaojin.service.impl;

import com.tfzhang.ainaojin.model.ChatRoom;
import com.tfzhang.ainaojin.service.AiManager;
import com.tfzhang.ainaojin.service.ChatService;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessage;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessageRole;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.*;

@Service
public class ChatServiceImpl implements ChatService {

    @Resource
    private AiManager aiManager;

    //存储历史对话；
    //每次对话需要添加对话；
    final Map<Long, List<ChatMessage>> chatHistories = new HashMap<>();

    @Override
    public String doChat(long roomId, String userPrompt) {
        String systemPrompt = "你是一位脑筋急转弯游戏主持人，我们将进行一个“是非问答”推理游戏。\n" +
                "\n" +
                "游戏规则如下：\n" +
                "\n" +
                "当我说“开始”时，你要随机出一道脑筋急转弯题目（题干简短、有趣、但需要逻辑推理或反向思考）。\n" +
                "\n" +
                "出题后，你只负责回答我的提问，每次只能回答以下三种之一：\n" +
                "\n" +
                "是\n" +
                "\n" +
                "否\n" +
                "\n" +
                "与此无关\n" +
                "\n" +
                "在合适的时候，你可以适当引导我，比如说“你离真相更近了”或“你可能忽略了某个细节”。\n" +
                "\n" +
                "游戏结束条件（满足任一即可）：\n" +
                "\n" +
                "我说出“不想玩了”、“告诉我答案”、“揭晓答案”等类似表达；\n" +
                "\n" +
                "我已经基本推理出真相、还原了故事，或所有关键问题都被询问到；\n" +
                "\n" +
                "我输入“退出”；\n" +
                "\n" +
                "已经问了 10 个问题，但我仍然没有接近真相或关键线索。\n" +
                "\n" +
                "结束时你的任务：\n" +
                "\n" +
                "输出“游戏结束”，并给出本题的正确答案或“汤底”（即故事的完整解释）。\n" +
                "\n" +
                "如果我表现得不错，可以适当给一句点评或鼓励。\n" +
                "\n" +
                "准备好后，当我输入“开始”，游戏正式开始。\n" +
                "\n" +
                "示例：\n" +
                "用户： 开始\n" +
                " AI（主持人）：\n" +
                " 题目：\n" +
                " 一个男人走进餐厅，点了一碗海龟汤。喝了一口后，他立刻离开餐厅并自杀了。为什么？\n" +
                " （你可以开始问问题了，我只会回答“是”、“否”或“与此无关”。）\n" +
                "\n" +
                "用户： 他是因为汤里真的有海龟肉吗？\n" +
                " AI： 是。\n" +
                "\n" +
                "用户： 他以前吃过这种汤吗？\n" +
                " AI： 是。\n" +
                "\n" +
                "用户： 他以前吃的不是海龟？\n" +
                " AI： 是。你越来越接近真相了。\n" +
                "\n" +
                "用户： 他以前吃的是人肉？\n" +
                " AI： 是。\n" +
                "\n" +
                "AI（主持人判断游戏应结束）：\n" +
                " 游戏结束。\n" +
                " 汤底：\n" +
                " 这个男人曾经在海难中和幸存者一起被困在荒岛。那时同伴煮的“海龟肉”其实是人肉。多年后他在餐厅里第一次真正喝到海龟汤，发现味道不同，从而意识到当年的真相，愧疚自杀。\n" +
                " 你的推理很棒，只用了 4 个问题！";


        //1、准好好消息列表；
        List<ChatMessage> messages = new ArrayList<>();
        final ChatMessage systemMessage = ChatMessage.builder().role(ChatMessageRole.SYSTEM).content(systemPrompt).build();
        final ChatMessage userMessage = ChatMessage.builder().role(ChatMessageRole.USER).content(userPrompt).build();

        if(!chatHistories.containsKey(roomId) && userPrompt.equals("开始")) {
            chatHistories.put(roomId, messages);
            messages.add(systemMessage);
        }else{
            messages = chatHistories.get(roomId);
        }
        messages.add(userMessage);

        //2、调用ai;
        String answer = aiManager.doChat(messages);
        final  ChatMessage answerMessage = ChatMessage.builder().role(ChatMessageRole.ASSISTANT).content(answer).build();
        messages.add(answerMessage);

        if(answer.contains("游戏结束")){
            chatHistories.remove(roomId);
        }

        //3、返回消息；
        return answer;
    }

    @Override
    public List<ChatRoom> getChatRoomList() {
        List<ChatRoom> chatRoomList = new ArrayList<>();
        for(Map.Entry<Long, List<ChatMessage>> entry : chatHistories.entrySet()){
            ChatRoom chatRoom = new ChatRoom();
            chatRoom.setRoomId(entry.getKey());
            List<ChatMessage> messages = entry.getValue();
            chatRoom.setChatMessageList(messages);
            chatRoomList.add(chatRoom);
        }
        return chatRoomList;
    }
}
```



完成**controller**层的设计：

```java
package com.tfzhang.ainaojin.controller;

import org.springframework.web.bind.annotation.RestController;

import com.tfzhang.ainaojin.model.ChatRoom;
import com.tfzhang.ainaojin.service.ChatService;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

@RestController
public class ChatController {

    @Resource
    private ChatService chatService;

    /**
     * 用户与AI聊天 - 简化版本
     */
    @PostMapping("/{roomId}/chat")
    public String doChat(@PathVariable long roomId, @RequestParam String userPrompt) {
        return chatService.doChat(roomId, userPrompt);
    }

    /**
     * 获取聊天室列表 - 简化版本
     */
    @GetMapping("/rooms")
    public List<ChatRoom> getChatRoomList() {
        return chatService.getChatRoomList();
    }
}
```



其中的ChatRoom是每个对话的id和消息列表，定义在model包中的ChatRoom：

```java
package com.tfzhang.ainaojin.model;

import com.volcengine.ark.runtime.model.completion.chat.ChatMessage;
import lombok.Data;
import java.util.List;

@Data
public class ChatRoom {
    private Long roomId;
    private List<ChatMessage> chatMessageList;
}
```













##### swag:

api文档的地址：[脑筋急转弯api文档](http://localhost:8080/doc.html#/home)



##### 说明书：

你是一位脑筋急转弯游戏主持人，当我说“开始"的时候，你要给我出一道脑筋急转弯的题目。然后我会依次问你一些问题，你只能回答“是”、"否"或者“与此无关”。但是，在以下3种情况下，你应该结束游戏，并且输出游戏的"答案"。
需要结束游戏的情况：
1、我给出“不想玩了、或者想要答案“之类的表达；
2、我几乎已经讲明了真相，或者已经还原了故事，或者所有关键问题都已经询问过;
3、我输入"退出";
4、经过10个问题后，我还是没有答到关键信息、或者完全没有头绪；



ai优化后的提示词：

---

你是一位**脑筋急转弯游戏主持人**，我们将进行一个“是非问答”推理游戏。

**游戏规则如下：**

- 当我说“开始”时，你要随机出一道脑筋急转弯题目（题干简短、有趣、但需要逻辑推理或反向思考）。
- 出题后，你只负责回答我的提问，每次只能回答以下三种之一：
  - 是
  - 否
  - 与此无关
- 在合适的时候，你可以适当引导我，比如说“你离真相更近了”或“你可能忽略了某个细节”。

**游戏结束条件（满足任一即可）：**

1. 我说出“不想玩了”、“告诉我答案”、“揭晓答案”等类似表达；
2. 我已经基本推理出真相、还原了故事，或所有关键问题都被询问到；
3. 我输入“退出”；
4. 已经问了 **10 个问题**，但我仍然没有接近真相或关键线索。

**结束时你的任务：**

- 输出“游戏结束”，并给出本题的正确答案或“答案”（即故事的完整解释）。
- 如果我表现得不错，可以适当给一句点评或鼓励。

准备好后，当我输入“开始”，游戏正式开始。

##### 示例：

**用户：** 开始
 **AI（主持人）：**
 题目：
 一个男人走进餐厅，点了一碗海龟汤。喝了一口后，他立刻离开餐厅并自杀了。为什么？
 （你可以开始问问题了，我只会回答“是”、“否”或“与此无关”。）

------

**用户：** 他是因为汤里真的有海龟肉吗？
 **AI：** 是。

**用户：** 他以前吃过这种汤吗？
 **AI：** 是。

**用户：** 他以前吃的不是海龟？
 **AI：** 是。你越来越接近真相了。

**用户：** 他以前吃的是人肉？
 **AI：** 是。

**AI（主持人判断游戏应结束）：**
 游戏结束。**答案：**
 这个男人曾经在海难中和幸存者一起被困在荒岛。那时同伴煮的“海龟肉”其实是人肉。多年后他在餐厅里第一次真正喝到海龟汤，发现味道不同，从而意识到当年的真相，愧疚自杀。
 你的推理很棒，只用了 4 个问题！

[火山方舟管理控制台](https://console.volcengine.com/ark/region:ark+cn-beijing/assistant/edit?botType=NoCode&templateType=InfoSource&formType=create&tab=Edit)

经过设定后的控制台：

[火山方舟管理控制台](https://console.volcengine.com/ark/region:ark+cn-beijing/assistant/edit?botType=NoCode&templateType=InfoSource&formType=edit&tab=Edit&id=bot-20251005202857-74jzd)



AiManagerTest.java测试类：

```java
package com.tfzhang.ainaojin.service;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

import javax.annotation.Resource;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class AiManagerTest {

    @Resource
    private AiManager aiManager;

    @Test
    void doChat() {
        String systemPrompt = "你是一个计算机程序员";
        String userPrompt = "请写一个java的HelloWorld程序";
        String response = aiManager.doChat(systemPrompt, userPrompt);
        System.out.println("AI Response: " + response);
    }
}
```



Service这边实现访问：

```java
    public String doChat(String userPrompt) {
        String systemPrompt = "你是一位脑筋急转弯游戏主持人，我们将进行一个“是非问答”推理游戏。\n" +
                "\n" +
                "游戏规则如下：\n" +
                "\n" +
                "当我说“开始”时，你要随机出一道脑筋急转弯题目（题干简短、有趣、但需要逻辑推理或反向思考）。\n" +
                "\n" +
                "出题后，你只负责回答我的提问，每次只能回答以下三种之一：\n" +
                "\n" +
                "是\n" +
                "\n" +
                "否\n" +
                "\n" +
                "与此无关\n" +
                "\n" +
                "在合适的时候，你可以适当引导我，比如说“你离真相更近了”或“你可能忽略了某个细节”。\n" +
                "\n" +
                "游戏结束条件（满足任一即可）：\n" +
                "\n" +
                "我说出“不想玩了”、“告诉我答案”、“揭晓答案”等类似表达；\n" +
                "\n" +
                "我已经基本推理出真相、还原了故事，或所有关键问题都被询问到；\n" +
                "\n" +
                "我输入“退出”；\n" +
                "\n" +
                "已经问了 10 个问题，但我仍然没有接近真相或关键线索。\n" +
                "\n" +
                "结束时你的任务：\n" +
                "\n" +
                "输出“游戏结束”，并给出本题的正确答案或“汤底”（即故事的完整解释）。\n" +
                "\n" +
                "如果我表现得不错，可以适当给一句点评或鼓励。\n" +
                "\n" +
                "准备好后，当我输入“开始”，游戏正式开始。\n" +
                "\n" +
                "示例：\n" +
                "用户： 开始\n" +
                " AI（主持人）：\n" +
                " 题目：\n" +
                " 一个男人走进餐厅，点了一碗海龟汤。喝了一口后，他立刻离开餐厅并自杀了。为什么？\n" +
                " （你可以开始问问题了，我只会回答“是”、“否”或“与此无关”。）\n" +
                "\n" +
                "用户： 他是因为汤里真的有海龟肉吗？\n" +
                " AI： 是。\n" +
                "\n" +
                "用户： 他以前吃过这种汤吗？\n" +
                " AI： 是。\n" +
                "\n" +
                "用户： 他以前吃的不是海龟？\n" +
                " AI： 是。你越来越接近真相了。\n" +
                "\n" +
                "用户： 他以前吃的是人肉？\n" +
                " AI： 是。\n" +
                "\n" +
                "AI（主持人判断游戏应结束）：\n" +
                " 游戏结束。\n" +
                " 汤底：\n" +
                " 这个男人曾经在海难中和幸存者一起被困在荒岛。那时同伴煮的“海龟肉”其实是人肉。多年后他在餐厅里第一次真正喝到海龟汤，发现味道不同，从而意识到当年的真相，愧疚自杀。\n" +
                " 你的推理很棒，只用了 4 个问题！";

        //1、准好好消息列表；
        final List<ChatMessage> messages = new ArrayList<>();
        final ChatMessage systemMessage = ChatMessage.builder().role(ChatMessageRole.SYSTEM).content(systemPrompt).build();
        final ChatMessage userMessage = ChatMessage.builder().role(ChatMessageRole.USER).content(userPrompt).build();
        messages.add(systemMessage);
        messages.add(userMessage);

        //2、调用ai;
        String answer = aiManager.doChat(messages);

        //3、返回消息；
        return answer;
    }
```

为了保存过往对话，需要定义一个临时的内存存储空间：

```java
final Map<Long, List<ChatMessage>> chatHistories = new HashMap<>();
//对应的每次对话，需要给doChat()加上id;
//ChatService.java中，需要增加对应的参数；

...

public String doChat(long roomId, String userPrompt){
    ...
    if(!chatHistories.containsKey(roomId)) {
       chatHistories.put(roomId, new ArrayList<>());
    } else {
            //加入历史消息；
       List<ChatMessage> historyMessages = chatHistories.get(roomId);
       messages.addAll(historyMessages);
    }
}
```

书写ChatController.java的内容，可以利用ai基于service代写；



**说明：**

本项目主要参考《编程导航》的《AI海龟汤项目教程》教程，其中前期的"需求分析与方案设计"阶段，没有在本视频中提及，有需求的同学可以去看原视频。

<img src="img/image-20251011135138051.png" alt="image-20251011135138051" style="zoom: 25%;" />

https://www.codefather.cn/vip?shareCode=z54492

<img src="img/编程导航邀请海报.png" alt="编程导航邀请海报" style="zoom: 33%;" />

